<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美团代付 - 邀请好友付款</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        body { background-color: #f5f5f5; padding-bottom: 30px; }
        .header { background: #fff; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        .back-btn { width: 24px; height: 24px; cursor: pointer; }
        .header-title { font-size: 18px; font-weight: 600; color: #333; }
        .config-btn { color: #ffc107; font-size: 16px; font-weight: 500; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .container { max-width: 480px; margin: 0 auto; padding: 16px; }
        .user-info { background: #fff; border-radius: 12px; padding: 20px; margin-top: 16px; display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 1px solid #f0f0f0; }
        .user-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 4px; }
        .user-desc { font-size: 14px; color: #666; line-height: 1.4; }
        .pay-card { background: #fff; border-radius: 12px; padding: 24px; margin-top: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .pay-amount { font-size: 48px; font-weight: 700; color: #333; margin-bottom: 24px; letter-spacing: -1px; }
        .pay-btn { width: 100%; background: #ffc107; color: #000; border: none; border-radius: 8px; padding: 16px; font-size: 18px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .pay-btn:hover { background: #ffb700; }
        .wechat-pay-btn { width: 100%; background: #07C160; color: white; border: none; padding: 16px; font-size: 18px; font-weight: 600; border-radius: 8px; cursor: pointer; margin-top: 12px; }
        .order-detail { background: #fff; border-radius: 12px; padding: 20px; margin-top: 16px; }
        .detail-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px; }
        .goods-list { display: flex; flex-direction: column; gap: 16px; }
        .goods-item { display: flex; gap: 12px; align-items: flex-start; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
        .goods-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .goods-name { font-size: 14px; color: #333; line-height: 1.5; margin-bottom: 4px; }
        .goods-price { font-size: 16px; font-weight: 600; color: #ff4444; margin-bottom: 4px; }
        .goods-count { font-size: 14px; color: #999; }
        .mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        .pay-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 12px; padding: 24px; z-index: 100; display: none; width: 90%; max-width: 320px; text-align: center; }
        .modal-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .code-img { width: 180px; height: 180px; object-fit: cover; margin: 0 auto 8px; border-radius: 8px; }
        .code-desc { font-size: 14px; color: #666; margin-bottom: 4px; }
        .transfer-note { background-color: #f5f5f5; padding: 8px 12px; border-radius: 4px; margin: 12px 0; font-size: 14px; color: #333; }
        .close-modal { width: 100%; background: #f5f5f5; border: none; border-radius: 8px; padding: 12px; font-size: 16px; color: #333; cursor: pointer; margin-top: 12px; }
        .success-btn { width: 100%; background: #07c160; color: #fff; border: none; border-radius: 8px; padding: 12px; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .config-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 999; padding: 20px; overflow-y: auto; display: none; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .panel-title { font-size: 20px; font-weight: 600; color: #333; }
        .close-panel { width: 24px; height: 24px; cursor: pointer; }
        .config-form { display: flex; flex-direction: column; gap: 16px; }
        .form-label { font-size: 14px; color: #333; font-weight: 500; }
        .form-input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; color: #333; }
        .save-config { background: #ffc107; color: #000; border: none; border-radius: 8px; padding: 16px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        < img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5OTk5OTkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjEgMTFIM2MtLjU1IDAtMS4wNS40NS0xIDEgMCAuMTguMDQuMzUuMDkuNTdsNiA2YzEuMjQgMS4yNCAzLjIyIDEuMjQgNC40NiAwbDYtNmMuMTUtLjE1LjI3LS4zOS4yOS0uNjVjMC0uNTUtLjQ1LTEtMS0xek0xOSAxMUw5IDE5VjV6Ii8+PC9zdmc+" alt="返回" class="back-btn" onclick="window.history.back()">
        <div class="header-title">邀请好友代付</div>
        <span class="config-btn" onclick="showConfigPanel()">配置</span>
    </div>

    <div class="container">
        <div class="user-info">
            < img src="https://imgchr.com/i/6Z7X8K" alt="用户头像" class="user-avatar" id="avatar-img">
            <div class="user-meta">
                <div class="user-name" id="user-name">小团同学</div>
                <div class="user-desc" id="user-desc">想喝奶茶啦，求好友赞助~</div>
            </div>
        </div>

        <div class="pay-card">
            <div class="pay-amount" id="pay-amount">¥26.50</div>
            <button class="pay-btn" onclick="getPayInfo()">微信/支付宝支付</button>
            <button class="wechat-pay-btn" onclick="getPayInfo()">微信快捷支付</button>
        </div>

        <div class="order-detail">
            <div class="detail-title">订单详情</div>
            <div class="goods-list" id="goodsList">
                <div class="goods-item">
                    < img src="https://imgchr.com/i/7ZJvq1" alt="商品图片" class="goods-img">
                    <div class="goods-meta">
                        <div class="goods-name">珍珠奶茶（中杯）</div>
                        <div class="goods-price">¥12.50</div>
                        <div class="goods-count">1份 · 无需备注</div>
                    </div>
                </div>
                <div class="goods-item">
                    < img src="https://imgchr.com/i/7ZJvq1" alt="商品图片" class="goods-img">
                    <div class="goods-meta">
                        <div class="goods-name">脆筒冰淇淋</div>
                        <div class="goods-price">¥3.00</div>
                        <div class="goods-count">1份 · 无需备注</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 收款码弹窗 -->
    <div class="mask" id="payMask" onclick="closePayModal()"></div>
    <div class="pay-modal" id="payModal">
        <div class="modal-title">选择支付方式</div>
        <div class="code-img" id="wx-code-img"></div>
        <div class="code-desc">微信扫码付款</div>
        <div class="code-img" id="ali-code-img" style="margin-top:16px"></div>
        <div class="code-desc">支付宝扫码付款</div>
        <div class="transfer-note" id="transfer-note"></div>
        <button class="close-modal" onclick="closePayModal()">关闭</button>
        <button class="success-btn" onclick="updateOrderStatus()">我已付款</button>
    </div>

    <!-- 配置面板 -->
    <div class="config-panel" id="configPanel">
        <div class="panel-header">
            <div class="panel-title">订单配置</div>
            < img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5OTk5OTkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjEgMTFIM2MtLjU1IDAtMS4wNS40NS0xIDEgMCAuMTguMDQuMzUuMDkuNTdsNiA2YzEuMjQgMS4yNCAzLjIyIDEuMjQgNC40NiAwbDYtNmMuMTUtLjE1LjI3LS4zOS4yOS0uNjVjMC0uNTUtLjQ1LTEtMS0xek0xOSAxMUw5IDE5VjV6Ii8+PC9zdmc+" alt="关闭" class="close-panel" onclick="closeConfigPanel()">
        </div>
        <div class="config-form">
            <div class="form-group">
                <label class="form-label">用户名称</label>
                <input type="text" class="form-input" id="config-name" placeholder="输入名称" value="小团同学">
            </div>
            <div class="form-group">
                <label class="form-label">邀请文案</label>
                <input type="text" class="form-input" id="config-desc" placeholder="输入文案" value="想喝奶茶啦，求好友赞助~">
            </div>
            <div class="form-group">
                <label class="form-label">订单总金额</label>
                <input type="number" step="0.01" class="form-input" id="config-amount" placeholder="输入金额" value="26.50">
            </div>
            <button class="save-config" onclick="saveConfig()">保存配置</button>
        </div>
    </div>

    <script>
        let currentOrderId = "";

        // 获取收款信息
        function getPayInfo() {
            const amount = document.getElementById('pay-amount').innerText.replace('¥', '');
            // 动态获取商品列表
            const goods = [];
            document.querySelectorAll('.goods-item').forEach(item => {
                goods.push({
                    name: item.querySelector('.goods-name').innerText,
                    price: item.querySelector('.goods-price').innerText.replace('¥', ''),
                    count: item.querySelector('.goods-count').innerText.split('·')[0].trim()
                });
            });

            fetch('/api/create_pay_link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount, goods })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    currentOrderId = data.data.order_id;
                    document.getElementById('wx-code-img').src = data.data.wx_pay_code_url;
                    document.getElementById('ali-code-img').src = data.data.ali_pay_code_url;
                    document.getElementById('transfer-note').innerText = `备注：${data.data.transfer_note}`;
                    document.getElementById('payMask').style.display = 'block';
                    document.getElementById('payModal').style.display = 'block';
                } else {
                    alert(data.msg);
                }
            })
            .catch(err => {
                alert('获取收款信息失败，请重试');
                console.error(err);
            });
        }

        // 关闭弹窗
        function closePayModal() {
            document.getElementById('payMask').style.display = 'none';
            document.getElementById('payModal').style.display = 'none';
        }

        // 更新订单状态
        function updateOrderStatus() {
            if (!currentOrderId) return;
            fetch('/api/update_order_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: currentOrderId })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.msg);
                closePayModal();
            })
            .catch(err => console.error(err));
        }

        // 配置面板相关
        function showConfigPanel() {
            document.getElementById('configPanel').style.display = 'block';
        }
        function closeConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
        }
        function saveConfig() {
            const name = document.getElementById('config-name').value;
            const desc = document.getElementById('config-desc').value;
            const amount = document.getElementById('config-amount').value;
            document.getElementById('user-name').innerText = name;
            document.getElementById('user-desc').innerText = desc;
            document.getElementById('pay-amount').innerText = `¥${amount}`;
            closeConfigPanel();
        }
    </script>
</body>
</html>
